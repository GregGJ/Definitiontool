{"code":"import * as path from \"path\";\r\nimport * as fs from \"fs\";\r\nimport * as crypto from \"crypto\";\r\nexport class DefinitionTool {\r\n    constructor() {\r\n        /**\r\n         * 默认品质\r\n         */\r\n        this.defaultQuality = 80;\r\n        this.oldFileConfigMap = new Map();\r\n        this.customQualityMap = new Map();\r\n        this.fileMD5List = [];\r\n        this.excludeMap = new Map();\r\n    }\r\n    /**\r\n     *\r\n     * @param assets        工程assets路径\r\n     * @param lowDefinitionAssets     低清晰度路径\r\n     * @param dConfig           自定义设置\r\n     * @param fileConfigs       上次处理记录\r\n     */\r\n    start(assets, lowDefinitionAssets, configPath, fileRecordPath) {\r\n        let dConfig;\r\n        let fileConfigs;\r\n        if (configPath) {\r\n            let data = fs.readFileSync(configPath, \"utf-8\");\r\n            dConfig = JSON.parse(data);\r\n        }\r\n        if (fileRecordPath) {\r\n            let data = fs.readFileSync(fileRecordPath, \"utf-8\");\r\n            fileConfigs = JSON.parse(data);\r\n        }\r\n        //先确定两个路径是否正确\r\n        if (!fs.existsSync(assets) || !fs.existsSync(lowDefinitionAssets)) {\r\n            throw new Error(\"assets或assetsLD 文件夹不存在！\");\r\n        }\r\n        let assetsStats = fs.statSync(assets);\r\n        let assetsLDStats = fs.statSync(lowDefinitionAssets);\r\n        if (!assetsStats.isDirectory() || !assetsLDStats.isDirectory()) {\r\n            throw new Error(\"assets或assetsLD 必须是文件夹\");\r\n        }\r\n        //默认品质\r\n        this.defaultQuality = dConfig ? dConfig.defaultQuality : 80;\r\n        //老的文件记录\r\n        this.oldFileConfigMap.clear();\r\n        if (fileConfigs && fileConfigs.length) {\r\n            let fileConfig;\r\n            for (let index = 0; index < fileConfigs.length; index++) {\r\n                fileConfig = fileConfigs[index];\r\n                this.oldFileConfigMap.set(fileConfig.file, fileConfig);\r\n            }\r\n        }\r\n        //排除列表\r\n        this.excludeMap.clear();\r\n        this.excludeMap.set(\"resources\", \"resources\");\r\n        if (dConfig) {\r\n            for (let index = 0; index < dConfig.exclude.length; index++) {\r\n                const file = dConfig.exclude[index];\r\n                if (this.excludeMap.has(file)) {\r\n                    console.error(\"definitionConfig.json中的exclude列表存在重复：\" + file);\r\n                }\r\n                this.excludeMap.set(file, file);\r\n            }\r\n        }\r\n        //自定义品质\r\n        this.customQualityMap.clear();\r\n        if (dConfig) {\r\n            for (let index = 0; index < dConfig.customs.length; index++) {\r\n                const qualityData = dConfig.customs[index];\r\n                if (this.customQualityMap.has(qualityData.file)) {\r\n                    console.error(\"definitionConfig.json中的exclude列表存在重复：\" + qualityData.file);\r\n                }\r\n                this.customQualityMap.set(qualityData.file, qualityData.quality);\r\n            }\r\n        }\r\n        //构建所有文件列表\r\n        this.__buildFileMD5(assets, assets, this.fileMD5List);\r\n        let result = this.__buildFileList(assets);\r\n        this.__imageCompress(assets, lowDefinitionAssets, result);\r\n    }\r\n    __imageCompress(assetsPath, lowDefinitionAssets, fileList) {\r\n        let extname;\r\n        for (let index = 0; index < fileList.length; index++) {\r\n            const element = fileList[index];\r\n            extname = path.extname(element.file);\r\n            extname.toLocaleLowerCase();\r\n            if (extname == \".png\") {\r\n                this.__pngCompress(assetsPath, element.file, lowDefinitionAssets + \"/\" + element.file, element.quality);\r\n            }\r\n            else {\r\n                console.log(\"未处理：\", element.file);\r\n            }\r\n        }\r\n    }\r\n    __pngCompress(assetsPath, file, output, quality, speed = 3) {\r\n        //压缩产生的文件名\r\n        let m_fileName = file.replace(\".png\", \"\") + \"-m.png\";\r\n        let cmd = DefinitionTool.PNG_Compress_exe;\r\n        cmd += \" --quality \" + quality;\r\n        cmd += \" --speed \" + speed;\r\n        cmd += \" --force\";\r\n        cmd += \" --ext -m.png\";\r\n        cmd += \" \" + assetsPath + \"/\" + file;\r\n        // child_process.exec(cmd, (err, data) => {\r\n        //     if (err) {\r\n        //         if(err.message.indexOf(\"Not a PNG file\")>=0){\r\n        //             console.log(\"醉了！这个文件不是png,但后缀却是png:\"+file);\r\n        //         }\r\n        //         return;\r\n        //     }\r\n        //     this.mkDirbyFile(output);\r\n        //     fs.renameSync(assetsPath+\"/\"+m_fileName,output);\r\n        // });\r\n    }\r\n    /**\r\n     * 递归创建所有父级文件夹\r\n     * @param file\r\n     */\r\n    mkDirbyFile(file) {\r\n        file = path.resolve(file);\r\n        file = file.replace(/\\\\/g, \"/\");\r\n        const fileName = file.split(\"/\")[file.split(\"/\").length - 1];\r\n        file = file.replace(fileName, \"\");\r\n        fs.mkdirSync(file, { recursive: true });\r\n    }\r\n    getQuality(assetRoot, fileRelativePath) {\r\n        //如果直接找到了自定义品质\r\n        if (this.customQualityMap.has(fileRelativePath)) {\r\n            return this.customQualityMap.get(fileRelativePath);\r\n        }\r\n        //递归父容器是否定义了品质\r\n        let dirName = path.dirname(fileRelativePath);\r\n        while (true) {\r\n            //如果父级文件夹定义了品质\r\n            if (this.customQualityMap.has(dirName)) {\r\n                return this.customQualityMap.get(dirName);\r\n            }\r\n            dirName = path.dirname(dirName);\r\n            if (dirName == \".\") {\r\n                break;\r\n            }\r\n        }\r\n        return this.defaultQuality;\r\n    }\r\n    __buildFileList(assetsPath) {\r\n        let result = [];\r\n        //对比MD5得出那些文件需要重新生成\r\n        let currentFile;\r\n        let oldFile;\r\n        for (let index = 0; index < this.fileMD5List.length; index++) {\r\n            currentFile = this.fileMD5List[index];\r\n            //老的列表中没有，说明是新的\r\n            if (!this.oldFileConfigMap.has(currentFile.file)) {\r\n                result.push({\r\n                    file: currentFile.file,\r\n                    quality: this.getQuality(assetsPath, currentFile.file)\r\n                });\r\n                continue;\r\n            }\r\n            oldFile = this.oldFileConfigMap.get(currentFile.file);\r\n            //如果再自定义列表中\r\n            if (this.customQualityMap.has(currentFile.file)) {\r\n                const customQualtiy = this.customQualityMap.get(currentFile.file);\r\n                //如果自定义品质和上次的品质不同则需要重新构建\r\n                if (oldFile.quality != customQualtiy) {\r\n                    result.push({\r\n                        file: currentFile.file,\r\n                        quality: customQualtiy\r\n                    });\r\n                    continue;\r\n                }\r\n            }\r\n            oldFile = this.oldFileConfigMap.get(currentFile.file);\r\n            //MD5不相同\r\n            if (currentFile.md5 !== oldFile.md5) {\r\n                result.push({\r\n                    file: currentFile.file,\r\n                    quality: this.getQuality(assetsPath, currentFile.file)\r\n                });\r\n                continue;\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n    __buildFileMD5(root, assetsPath, out) {\r\n        let fileList = fs.readdirSync(assetsPath);\r\n        let filePath, status, fileBuffer;\r\n        let md5Code;\r\n        let md5;\r\n        let relativePath;\r\n        let extname;\r\n        for (let index = 0; index < fileList.length; index++) {\r\n            filePath = assetsPath + \"/\" + fileList[index];\r\n            status = fs.statSync(filePath);\r\n            relativePath = path.relative(root, filePath);\r\n            if (this.excludeMap.has(relativePath)) {\r\n                console.log(\"排除：\" + filePath);\r\n                continue;\r\n            }\r\n            if (status.isFile()) {\r\n                extname = path.extname(filePath);\r\n                extname = extname.toLocaleLowerCase();\r\n                if (extname != \".png\" && extname != \".jpg\") {\r\n                    continue;\r\n                }\r\n                fileBuffer = fs.readFileSync(filePath, { encoding: \"binary\" });\r\n                md5 = crypto.createHash(\"md5\");\r\n                md5Code = md5.update(fileBuffer).digest().toString(\"hex\");\r\n                relativePath = relativePath.replace(/\\\\/g, \"/\");\r\n                out.push({ file: relativePath, md5: md5Code });\r\n            }\r\n            else {\r\n                this.__buildFileMD5(root, filePath, out);\r\n            }\r\n        }\r\n    }\r\n}\r\nDefinitionTool.PNG_Compress_exe = \"D:/erciyuan/clientCS/GameWord/definitions/pngquant.exe\";\r\n","references":[]}
